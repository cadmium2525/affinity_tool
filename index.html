<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºç¤ç›¸æ€§å€¤ãƒ»æœ€é©åŒ–ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            padding: 15px;
            margin: 0;
            line-height: 1.5;
            touch-action: manipulation;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        h1 {
            font-size: 1.3rem;
            text-align: center;
            margin-bottom: 20px;
            color: #bb86fc;
        }

        h2 {
            font-size: 1.1rem;
            border-bottom: 2px solid #333;
            padding-bottom: 8px;
            margin-top: 0;
            color: #03dac6;
        }

        .card {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        /* --- Rich Buttons --- */
        button {
            padding: 12px 20px;
            width: 100%;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin-top: 10px;
        }

        button:active {
            transform: scale(0.98);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6200ea, #3700b3);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #7c4dff, #6200ea);
        }

        .btn-accent {
            background: linear-gradient(135deg, #03dac6, #018786);
            color: #000;
        }

        .btn-accent:hover {
            background: linear-gradient(135deg, #66fff9, #03dac6);
        }

        .btn-danger {
            background: linear-gradient(135deg, #cf6679, #b00020);
            color: white;
            width: auto;
            padding: 8px 16px;
            font-size: 0.8rem;
        }

        .btn-secondary {
            background: #333;
            color: #ddd;
            width: auto;
            padding: 8px 16px;
            font-size: 0.8rem;
        }

        /* --- Grid for Monster Selection --- */
        .parent-grid-row {
            display: grid;
            grid-template-columns: 30px 1fr 1fr 1fr;
            gap: 8px;
            align-items: center;
            margin-bottom: 15px;
        }

        .parent-label {
            writing-mode: vertical-rl;
            text-orientation: upright;
            font-size: 0.8rem;
            color: #888;
            font-weight: bold;
        }

        /* --- Help Button --- */
        .manual-btn {
            background: #444;
            color: #ccc;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 0.65rem;
            padding: 2px 8px;
            cursor: pointer;
            margin-left: 10px;
            vertical-align: middle;
            transition: all 0.2s;
            font-weight: normal;
            width: auto;
        }

        .manual-btn:hover {
            background: #666;
            color: #fff;
        }

        .monster-btn {
            background-color: #2d2d2d;
            border: 2px solid #444;
            border-radius: 8px;
            height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            transition: border-color 0.2s;
        }

        .monster-btn:hover {
            border-color: #666;
        }

        .monster-btn.selected {
            border-color: #bb86fc;
            background-color: #2a2a3a;
        }

        .monster-btn img {
            width: 90%;
            height: auto;
            max-height: 50px;
            object-fit: contain;
        }

        .monster-btn span {
            font-size: 0.6rem;
            margin-top: 2px;
            color: #ccc;
        }

        /* --- Sliders --- */
        .slider-container {
            margin-bottom: 20px;
        }

        .slider-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .adjust-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #333;
            color: white;
            margin: 0;
            padding: 0;
            font-size: 1.2rem;
        }

        input[type=range] {
            flex: 1;
            accent-color: #bb86fc;
            height: 6px;
            background: #333;
            border-radius: 3px;
        }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex !important;
        }

        .modal-content {
            background-color: #1e1e1e;
            margin: 0;
            padding: 20px;
            border-radius: 12px;
            width: 95%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid #444;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .modal-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .modal-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px;
            background: #2d2d2d;
            border-radius: 6px;
            cursor: pointer;
        }

        .modal-item:active {
            background: #555;
        }

        .modal-item img {
            width: 100%;
            max-width: 50px;
            height: auto;
            margin-bottom: 4px;
        }

        .modal-item span {
            font-size: 0.6rem;
            text-align: center;
            color: #eee;
            line-height: 1.1;
        }

        /* --- Results Table --- */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th,
        td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #333;
        }

        th {
            background-color: #252525;
            color: #aaa;
        }

        .symbol-select {
            width: 100%;
            padding: 8px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 1rem;
            text-align: center;
            appearance: none;
        }

        /* --- Logs --- */
        .monitor-panel {
            background: #000;
            color: #00ff00;
            font-family: 'Consolas', monospace;
            padding: 10px;
            border-radius: 6px;
            height: 120px;
            overflow-y: scroll;
            font-size: 0.75rem;
            margin-top: 10px;
            border: 1px solid #333;
        }

        /* --- Matrix Display --- */
        .matrix-scroll {
            overflow-x: auto;
            max-height: 400px;
            border: 1px solid #333;
            border-radius: 4px;
        }

        .matrix-table {
            font-size: 0.7rem;
            border-collapse: separate;
            border-spacing: 0;
        }

        .matrix-table th,
        .matrix-table td {
            min-width: 40px;
            height: 30px;
            border: 1px solid #222;
            text-align: center;
            vertical-align: middle;
        }

        .matrix-table th {
            background: #333;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 2px;
        }

        .matrix-table th img {
            width: 25px;
            height: 25px;
            vertical-align: middle;
        }

        .matrix-table th:first-child {
            position: sticky;
            left: 0;
            z-index: 20;
            background: #333;
        }

        .diff-pos {
            color: #55ff55;
            font-size: 0.6rem;
            display: block;
        }

        .diff-neg {
            color: #ff5555;
            font-size: 0.6rem;
            display: block;
        }

        .diff-zero {
            display: none;
        }

        .cell-changed {
            background-color: #3d2b00 !important;
        }

        /* --- Tabs --- */
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .tab-btn {
            background: none;
            border: none;
            color: #888;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: #03dac6;
            border-bottom: 2px solid #03dac6;
        }

        .tab-btn:hover {
            color: #ccc;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>
            åŸºç¤ç›¸æ€§å€¤ãƒ»æœ€é©åŒ–ãƒ„ãƒ¼ãƒ«
            <button class="manual-btn" onclick="openManual()">ä½¿ã„æ–¹</button>
        </h1>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('batch')">ä¸€æ‹¬èª¿æŸ»ãƒ¢ãƒ¼ãƒ‰</button>
            <button class="tab-btn" onclick="switchTab('individual')">å€‹åˆ¥èª¿æŸ»ãƒ¢ãƒ¼ãƒ‰</button>
        </div>

        <!-- === Batch Mode === -->
        <div id="mode-batch">
            <!-- Step 1: Input Parents -->
            <div class="card">
                <h2>â‘  è¦ªãƒ»ç¥–çˆ¶æ¯å…¥åŠ› <span style="font-size:0.8rem; color:#888; font-weight:normal;">(ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ)</span></h2>
                <div class="parent-grid-row">
                    <div class="parent-label">çˆ¶æ–¹</div>
                    <div onclick="openModal('input-f')">
                        <div class="monster-btn" id="btn-input-f"><span>çˆ¶é¸æŠ</span></div><input type="hidden"
                            id="input-f">
                    </div>
                    <div onclick="openModal('input-ff')">
                        <div class="monster-btn" id="btn-input-ff"><span>ç¥–çˆ¶é¸æŠ</span></div><input type="hidden"
                            id="input-ff">
                    </div>
                    <div onclick="openModal('input-fm')">
                        <div class="monster-btn" id="btn-input-fm"><span>ç¥–æ¯é¸æŠ</span></div><input type="hidden"
                            id="input-fm">
                    </div>
                </div>
                <div class="parent-grid-row">
                    <div class="parent-label">æ¯æ–¹</div>
                    <div onclick="openModal('input-m')">
                        <div class="monster-btn" id="btn-input-m"><span>æ¯é¸æŠ</span></div><input type="hidden"
                            id="input-m">
                    </div>
                    <div onclick="openModal('input-mf')">
                        <div class="monster-btn" id="btn-input-mf"><span>ç¥–çˆ¶é¸æŠ</span></div><input type="hidden"
                            id="input-mf">
                    </div>
                    <div onclick="openModal('input-mm')">
                        <div class="monster-btn" id="btn-input-mm"><span>ç¥–æ¯é¸æŠ</span></div><input type="hidden"
                            id="input-mm">
                    </div>
                </div>
                <div style="border-top: 1px solid #333; margin: 20px 0;"></div>
                <!-- Secret Inputs -->
                <div class="slider-container">
                    <label style="font-size:0.9rem; margin-bottom:5px; display:block;">å…±é€šç§˜ä¼III (<span id="v3-val"
                            style="color:#03dac6; font-weight:bold;">0</span>å€‹)</label>
                    <div class="slider-wrapper">
                        <button class="adjust-btn" onclick="adjustSlider('input-s3', -1)">-</button>
                        <input type="range" id="input-s3" min="0" max="20" value="0"
                            oninput="updateSliderVal('input-s3', 'v3-val')">
                        <button class="adjust-btn" onclick="adjustSlider('input-s3', 1)">+</button>
                    </div>
                </div>
                <div class="slider-container">
                    <label style="font-size:0.9rem; margin-bottom:5px; display:block;">å…±é€šç§˜ä¼II (<span id="v2-val"
                            style="color:#03dac6; font-weight:bold;">0</span>å€‹)</label>
                    <div class="slider-wrapper">
                        <button class="adjust-btn" onclick="adjustSlider('input-s2', -1)">-</button>
                        <input type="range" id="input-s2" min="0" max="20" value="0"
                            oninput="updateSliderVal('input-s2', 'v2-val')">
                        <button class="adjust-btn" onclick="adjustSlider('input-s2', 1)">+</button>
                    </div>
                </div>
                <div class="slider-container">
                    <div style="display:flex; align-items:center; margin-bottom:5px;">
                        <label style="font-size:0.9rem; margin-right:5px;">ãƒãƒ¼ãƒ–ãƒ«åŠ ç®—å€¤ (<span id="vn-val"
                                style="color:#03dac6; font-weight:bold;">0</span>)</label>
                        <button class="manual-btn" onclick="openNobleModal()" style="padding:2px 6px;">
                            <span style="font-size:1rem;">ğŸ“‹</span>
                        </button>
                    </div>
                    <div class="slider-wrapper">
                        <button class="adjust-btn" onclick="adjustSlider('input-noble', -0.5)">-</button>
                        <input type="range" id="input-noble" min="0" max="300" step="0.5" value="0"
                            oninput="updateSliderVal('input-noble', 'vn-val')">
                        <button class="adjust-btn" onclick="adjustSlider('input-noble', 0.5)">+</button>
                    </div>
                </div>
                <button onclick="generateTable()" class="btn-accent">å­ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º</button>
            </div>

            <!-- Step 2: Input Children Symbols -->
            <div class="card" id="step2-card" style="display:none;">
                <h2>â‘¡ æ¤œè¨¼ã¨ä¿®æ­£</h2>
                <p style="font-size:0.8rem; color:#aaa;">äºˆæ¸¬ã¨ç•°ãªã‚‹ã‚·ãƒ³ãƒœãƒ«ãŒã‚ã‚‹å ´åˆã¯ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚</p>
                <div style="max-height: 400px; overflow-y: auto; border:1px solid #333; border-radius:8px;">
                    <table id="children-table">
                        <thead>
                            <tr>
                                <th style="width:30%">ç¨®æ—</th>
                                <th style="width:15%">äºˆæ¸¬</th>
                                <th style="width:15%">å€¤</th>
                                <th>å®Ÿæ¸¬ (ä¿®æ­£)</th>
                            </tr>
                        </thead>
                        <tbody><!-- Generated via JS --></tbody>
                    </table>
                </div>
                <button onclick="commitObservations()" class="btn-primary" style="margin-top:15px;">ãƒªã‚¹ãƒˆã«è¿½åŠ  (ç¢ºå®š)</button>
            </div>
        </div>
        <!-- End Batch Mode -->

        <!-- === Individual Mode === -->
        <div id="mode-individual" style="display:none;">
            <div class="card">
                <h2>å€‹åˆ¥èª¿æŸ»å…¥åŠ›</h2>

                <!-- Child Selection -->
                <div style="margin-bottom: 20px; text-align:center;">
                    <label style="display:block; margin-bottom:5px; color:#aaa;">å¯¾è±¡ã®å­ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼</label>
                    <div onclick="openModal('input-ind-child')" style="display:inline-block;">
                        <div class="monster-btn" id="btn-input-ind-child" style="width:120px; height:auto;">
                            <span>å­é¸æŠ</span>
                        </div>
                        <input type="hidden" id="input-ind-child">
                    </div>
                </div>

                <div style="border-top: 1px solid #333; margin: 20px 0;"></div>

                <!-- Parents Grid (Duplicate of Batch for independence) -->
                <div class="parent-grid-row">
                    <div class="parent-label">çˆ¶æ–¹</div>
                    <div onclick="openModal('input-ind-f')">
                        <div class="monster-btn" id="btn-input-ind-f"><span>çˆ¶é¸æŠ</span></div><input type="hidden"
                            id="input-ind-f">
                    </div>
                    <div onclick="openModal('input-ind-ff')">
                        <div class="monster-btn" id="btn-input-ind-ff"><span>ç¥–çˆ¶é¸æŠ</span></div><input type="hidden"
                            id="input-ind-ff">
                    </div>
                    <div onclick="openModal('input-ind-fm')">
                        <div class="monster-btn" id="btn-input-ind-fm"><span>ç¥–æ¯é¸æŠ</span></div><input type="hidden"
                            id="input-ind-fm">
                    </div>
                </div>

                <div class="parent-grid-row">
                    <div class="parent-label">æ¯æ–¹</div>
                    <div onclick="openModal('input-ind-m')">
                        <div class="monster-btn" id="btn-input-ind-m"><span>æ¯é¸æŠ</span></div><input type="hidden"
                            id="input-ind-m">
                    </div>
                    <div onclick="openModal('input-ind-mf')">
                        <div class="monster-btn" id="btn-input-ind-mf"><span>ç¥–çˆ¶é¸æŠ</span></div><input type="hidden"
                            id="input-ind-mf">
                    </div>
                    <div onclick="openModal('input-ind-mm')">
                        <div class="monster-btn" id="btn-input-ind-mm"><span>ç¥–æ¯é¸æŠ</span></div><input type="hidden"
                            id="input-ind-mm">
                    </div>
                </div>

                <div style="border-top: 1px solid #333; margin: 20px 0;"></div>

                <!-- Secret Inputs -->
                <div class="slider-container">
                    <label>å…±é€šç§˜ä¼III (<span id="v3-ind-val" style="color:#03dac6; font-weight:bold;">0</span>å€‹)</label>
                    <div class="slider-wrapper">
                        <button class="adjust-btn" onclick="adjustSlider('input-ind-s3', -1)">-</button>
                        <input type="range" id="input-ind-s3" min="0" max="20" value="0"
                            oninput="updateSliderVal('input-ind-s3', 'v3-ind-val')">
                        <button class="adjust-btn" onclick="adjustSlider('input-ind-s3', 1)">+</button>
                    </div>
                </div>
                <div class="slider-container">
                    <label>å…±é€šç§˜ä¼II (<span id="v2-ind-val" style="color:#03dac6; font-weight:bold;">0</span>å€‹)</label>
                    <div class="slider-wrapper">
                        <button class="adjust-btn" onclick="adjustSlider('input-ind-s2', -1)">-</button>
                        <input type="range" id="input-ind-s2" min="0" max="20" value="0"
                            oninput="updateSliderVal('input-ind-s2', 'v2-ind-val')">
                        <button class="adjust-btn" onclick="adjustSlider('input-ind-s2', 1)">+</button>
                    </div>
                </div>
                <div class="slider-container">
                    <div style="display:flex; align-items:center; margin-bottom:5px;">
                        <label style="font-size:0.9rem; margin-right:5px;">ãƒãƒ¼ãƒ–ãƒ«åŠ ç®—å€¤ (<span id="vn-ind-val"
                                style="color:#03dac6; font-weight:bold;">0</span>)</label>
                        <button class="manual-btn" onclick="openNobleModal()" style="padding:2px 6px;">
                            <span style="font-size:1rem;">ğŸ“‹</span>
                        </button>
                    </div>
                    <div class="slider-wrapper">
                        <button class="adjust-btn" onclick="adjustSlider('input-ind-noble', -0.5)">-</button>
                        <input type="range" id="input-ind-noble" min="0" max="300" step="0.5" value="0"
                            oninput="updateSliderVal('input-ind-noble', 'vn-ind-val')">
                        <button class="adjust-btn" onclick="adjustSlider('input-ind-noble', 0.5)">+</button>
                    </div>
                </div>

                <button onclick="calcIndividual()" class="btn-accent">ç›¸æ€§ã‚’è¨ˆç®—</button>
            </div>

            <!-- Result Card -->
            <div class="card" id="ind-result-card" style="display:none;">
                <h2>è¨ˆç®—çµæœ & ç™»éŒ²</h2>
                <div style="text-align:center; margin-bottom:20px;">
                    <div style="font-size:0.9rem; color:#888;">äºˆæ¸¬ç›¸æ€§å€¤</div>
                    <div id="ind-score-display" style="font-size:2rem; font-weight:bold; color:#03dac6;">-</div>
                    <div id="ind-symbol-display" style="font-size:1.5rem;">-</div>
                </div>

                <div style="background:#222; padding:15px; border-radius:8px;">
                    <label style="display:block; margin-bottom:10px; font-size:0.9rem;">å®Ÿæ¸¬ã‚·ãƒ³ãƒœãƒ« (ä¿®æ­£)</label>
                    <select id="ind-actual-symbol" class="symbol-select" style="margin-bottom:15px;">
                        <option value="ğŸ‘‘">ğŸ‘‘</option>
                        <option value="â˜†">â˜†</option>
                        <option value="â—">â—</option>
                        <option value="â—‹">â—‹</option>
                        <option value="â–³">â–³</option>
                        <option value="Ã—">Ã—</option>
                    </select>
                    <button onclick="commitIndividual()" class="btn-primary">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
                </div>
            </div>
        </div>
        <!-- End Individual Mode -->


        <!-- Step 3: Optimization -->
        <div class="card">
            <h2>â‘¢ æœ€é©åŒ–å®Ÿè¡Œ</h2>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-size:0.9rem;">ç™»éŒ²ãƒ‡ãƒ¼ã‚¿æ•°: <span id="obs-count"
                        style="font-weight:bold; font-size:1.2rem;">0</span></div>
                <div style="display:flex; gap:5px;">
                    <button type="button" onclick="backupData()" class="btn-secondary"
                        title="æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ä¿å­˜ã—ã¾ã™">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</button>
                    <label class="btn-secondary"
                        style="margin-top:10px; display:flex; align-items:center; justify-content:center; cursor:pointer;"
                        title="JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™">
                        ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­è¾¼ <input type="file" onchange="restoreData(this)" accept=".json" style="display:none;">
                    </label>
                    <button type="button" onclick="execClear()" class="btn-danger">å…¨ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <button onclick="runOptimization()" id="btn-optimize" class="btn-primary">æœ€é©åŒ–ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

            <div class="progress-bar-container" id="progress-container"
                style="display:none; margin-top:10px; background:#333; height:8px; border-radius:4px; overflow:hidden;">
                <div class="progress-bar" id="progress-bar" style="width:0%; height:100%; background:#03dac6;"></div>
            </div>

            <div class="monitor-panel" id="log-panel">
                <div style="color:#888;">System Ready...</div>
            </div>
        </div>

        <!-- Step 4: Result Matrix -->
        <div class="card">
            <h2>â‘£ åŸºç¤ç›¸æ€§å€¤ãƒãƒˆãƒªã‚¯ã‚¹ (æœ€é©åŒ–å¾Œ)</h2>
            <p style="font-size:0.8rem; color:#aaa;">å¤‰æ›´ã•ã‚ŒãŸã‚»ãƒ«ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            <div class="matrix-scroll">
                <table class="matrix-table" id="matrix-display">
                    <!-- Populated by JS -->
                </table>
            </div>
            <div style="text-align: right; margin-top: 10px;">
                <button onclick="saveMatrixImage()" class="btn-secondary"
                    style="width:auto; font-size:0.75rem; padding:6px 12px; background:#2a2a2a; color:#888; margin-right:10px;">ç”»åƒä¿å­˜</button>
                <button onclick="exportAsPatch()" class="btn-secondary"
                    style="width:auto; font-size:0.75rem; padding:6px 12px; background:#2a2a2a; color:#888;">ãƒ‘ãƒƒãƒã‚’ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Modal Element: Monster Selection -->
    <div id="monster-modal-ui" class="modal">
        <div class="modal-content">
            <h3 style="text-align:center; border-bottom:1px solid #444; padding-bottom:10px;">ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼é¸æŠ</h3>
            <div id="modal-list" class="modal-grid"></div>
            <button onclick="closeModalUI()" class="btn-secondary" style="margin-top:20px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- Modal Element: Manual -->
    <div id="manual-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 style="text-align:center; border-bottom:1px solid #444; padding-bottom:10px; margin-top:0;">ä½¿ã„æ–¹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«
            </h3>
            <div class="manual-section">
                <h3>1. è¦ªãƒ»ç¥–çˆ¶æ¯ã®å…¥åŠ› (â‘ )</h3>
                <p>å„æ ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€å¯¾è±¡ã®ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰é¸æŠã—ã¾ã™ã€‚</p>
                <h3>2. å…±é€šç§˜ä¼ã®å…¥åŠ›</h3>
                <p>ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§å…±é€šç§˜ä¼IIIã¨IIã®å€‹æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚</p>
                <h3>3. æ¤œè¨¼ã¨ä¿®æ­£ (â‘¡)</h3>
                <p>ã€Œå­ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤ºã€ã‚’æŠ¼ã™ã¨ã€äºˆæ¸¬çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                <p>ã‚²ãƒ¼ãƒ å†…ã®çµæœã¨ç•°ãªã‚‹å ´åˆã€ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰æ­£ã—ã„ã‚·ãƒ³ãƒœãƒ«ã‚’é¸æŠã—ã€ã€Œãƒªã‚¹ãƒˆã«è¿½åŠ  (ç¢ºå®š)ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                <h3>4. æœ€é©åŒ–å®Ÿè¡Œ (â‘¢)</h3>
                <p>ã€Œæœ€é©åŒ–ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’æŠ¼ã™ã¨ã€ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã«åˆã‚ã›ã¦ç›¸æ€§å€¤ãŒè‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™ã€‚</p>
                <h3>5. çµæœã®ä¿å­˜ã¨å¾©å…ƒ</h3>
                <p><strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜</strong>: æ¤œè¨¼ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚<br>
                    <strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­è¾¼</strong>: ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ¤œè¨¼ã‚’å†é–‹ã§ãã¾ã™ã€‚
                </p>
            </div>
            <button onclick="closeManual()" class="btn-primary" style="margin-top:20px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- Modal Element: Noble Table -->
    <div id="noble-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <h3 style="text-align:center; border-bottom:1px solid #444; padding-bottom:10px;">ãƒãƒ¼ãƒ–ãƒ«ç§˜ä¼ åŠ ç®—å€¤è¡¨</h3>
            <div
                style="display:grid; grid-template-columns: repeat(6, 1fr); gap:4px; max-height:400px; overflow-y:auto; text-align:center;">
                <!-- 1-6 -->
                <div class="modal-item" style="color:#bb86fc;">â˜…1</div>
                <div class="modal-item" style="color:#bb86fc;">â˜…2</div>
                <div class="modal-item" style="color:#bb86fc;">â˜…3</div>
                <div class="modal-item" style="color:#bb86fc;">â˜…4</div>
                <div class="modal-item" style="color:#bb86fc;">â˜…5</div>
                <div class="modal-item" style="color:#bb86fc;">â˜…6</div>
                <div class="modal-item">8.5</div>
                <div class="modal-item">14</div>
                <div class="modal-item">20</div>
                <div class="modal-item">25.5</div>
                <div class="modal-item">31.5</div>
                <div class="modal-item">37</div>

                <!-- 7-12 -->
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…7</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…8</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…9</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…10</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…11</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…12</div>
                <div class="modal-item">43</div>
                <div class="modal-item">48.5</div>
                <div class="modal-item">54.5</div>
                <div class="modal-item">60</div>
                <div class="modal-item">66</div>
                <div class="modal-item">71.5</div>

                <!-- 13-18 -->
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…13</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…14</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…15</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…16</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…17</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…18</div>
                <div class="modal-item">77.5</div>
                <div class="modal-item">83</div>
                <div class="modal-item">89</div>
                <div class="modal-item">94.5</div>
                <div class="modal-item">100.5</div>
                <div class="modal-item">106</div>

                <!-- 19-24 -->
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…19</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…20</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…21</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…22</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…23</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…24</div>
                <div class="modal-item">108</div>
                <div class="modal-item">110</div>
                <div class="modal-item">112</div>
                <div class="modal-item">114</div>
                <div class="modal-item">116</div>
                <div class="modal-item">118</div>

                <!-- 25-30 -->
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…25</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…26</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…27</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…28</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…29</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…30</div>
                <div class="modal-item">120</div>
                <div class="modal-item">122</div>
                <div class="modal-item">124</div>
                <div class="modal-item">126</div>
                <div class="modal-item">128</div>
                <div class="modal-item">134</div>

                <!-- 31-36 -->
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…31</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…32</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…33</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…34</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…35</div>
                <div class="modal-item" style="color:#bb86fc; margin-top:8px;">â˜…36</div>
                <div class="modal-item">140</div>
                <div class="modal-item">146</div>
                <div class="modal-item">152</div>
                <div class="modal-item">158</div>
                <div class="modal-item">164</div>
                <div class="modal-item">170</div>
            </div>
            <button onclick="closeNobleModal()" class="btn-secondary" style="margin-top:20px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/data.js"></script>
    <script src="js/solver_logic.js"></script>
    <script>
        const solverData = new SolverData();
        let optimizer = null;
        let currentModalTarget = null;
        let currentContext = {};

        // --- Persistence for App State (Matrix + Inputs) ---
        function saveAppState() {
            // Collect inputs
            const inputs = {};
            ['input-f', 'input-ff', 'input-fm', 'input-m', 'input-mf', 'input-mm', 'input-s3', 'input-s2', 'input-noble'].forEach(id => {
                const el = document.getElementById(id);
                if (el) inputs[id] = el.value;
            });
            // Individual mode inputs? Request said "Parent/Grandparent input info", assuming mainly the main batch ones or all?
            // Let's save both sets just in case, or at least the main ones.

            const state = {
                inputs: inputs,
                matrix: optimizer ? optimizer.matrix : null
            };
            localStorage.setItem('affinity_tool_state', JSON.stringify(state));
        }

        function loadAppState() {
            const data = localStorage.getItem('affinity_tool_state');
            if (data) {
                try {
                    const state = JSON.parse(data);
                    if (state.matrix && optimizer) {
                        optimizer.matrix = state.matrix;
                        renderMatrix(optimizer.matrix, optimizer.originalMatrix);
                        console.log("Restored optimized matrix.");
                    }
                    if (state.inputs) {
                        Object.keys(state.inputs).forEach(id => {
                            const val = state.inputs[id];
                            const el = document.getElementById(id);
                            if (el) {
                                el.value = val;
                                // Update UI if it's a slider
                                if (id.includes('s3')) updateSliderVal(id, 'v3-val');
                                if (id.includes('s2')) updateSliderVal(id, 'v2-val');
                                if (id.includes('noble')) updateSliderVal(id, 'vn-val');

                                // Update buttons if it is a monster input
                                if (id.includes('input-f') || id.includes('input-m')) {
                                    // Need to invoke select logic visually
                                    if (val !== "" && val !== null) {
                                        const numVal = Number(val);
                                        if (!isNaN(numVal) && MONSTER_NAMES[numVal]) {
                                            const btn = document.getElementById('btn-' + id);
                                            btn.innerHTML = `<img src="images/${MONSTER_NAMES[numVal]}.png"><span>${MONSTER_NAMES[numVal]}</span>`;
                                            btn.classList.add('selected');
                                        }
                                    }
                                }
                            }
                        });
                    }
                } catch (e) {
                    console.error("Failed to load app state", e);
                }
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            // Hook inputs for auto-saving
            const allInputs = document.querySelectorAll('input');
            allInputs.forEach(inp => {
                inp.addEventListener('change', saveAppState);
            });

            if (typeof COMPATIBILITY_MATRIX !== 'undefined') {
                optimizer = new CompatibilityOptimizer(COMPATIBILITY_MATRIX);
                // Try load state
                loadAppState();
                if (!localStorage.getItem('affinity_tool_state')) {
                    renderMatrix(optimizer.matrix, optimizer.originalMatrix);
                }
            }
            updateCountDisplay();
        });

        function updateCountDisplay() {
            document.getElementById('obs-count').textContent = solverData.getObservations().length;
        }

        // --- Slider Logic ---
        function adjustSlider(id, delta) {
            const el = document.getElementById(id);
            let val = Number(el.value) + delta;
            val = Math.max(Number(el.min), Math.min(Number(el.max), val));
            el.value = val;
            el.dispatchEvent(new Event('input'));
            el.dispatchEvent(new Event('change')); // Trigger save
        }

        function updateSliderVal(id, displayId) {
            document.getElementById(displayId).innerText = document.getElementById(id).value;
        }

        // --- Tab Switching ---
        function switchTab(mode) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#mode-batch, #mode-individual').forEach(d => d.style.display = 'none');

            if (mode === 'batch') {
                document.getElementById('mode-batch').style.display = 'block';
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
            } else {
                document.getElementById('mode-individual').style.display = 'block';
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
            }
        }

        // --- Individual Mode Logic ---
        let currentIndContext = {};

        function calcIndividual() {
            const getVal = (id) => document.getElementById(id).value === "" ? null : Number(document.getElementById(id).value);

            const inputs = {
                child: getVal('input-ind-child'),
                f: getVal('input-ind-f'), ff: getVal('input-ind-ff'), fm: getVal('input-ind-fm'),
                m: getVal('input-ind-m'), mf: getVal('input-ind-mf'), mm: getVal('input-ind-mm'),
                s3: Number(document.getElementById('input-ind-s3').value),
                s2: Number(document.getElementById('input-ind-s2').value)
            };

            if (inputs.child === null || inputs.f === null || inputs.ff === null || inputs.fm === null ||
                inputs.m === null || inputs.mf === null || inputs.mm === null) {
                alert("ã™ã¹ã¦ã®é …ç›®ï¼ˆå­ãƒ»è¦ªãƒ»ç¥–çˆ¶æ¯ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„");
                return;
            }

            currentIndContext = inputs; // Store for commit

            const score = optimizer.calculateScore(
                inputs.child, inputs.f, inputs.ff, inputs.fm, inputs.m, inputs.mf, inputs.mm,
                inputs.s3, inputs.s2, Number(document.getElementById('input-ind-noble').value), optimizer.matrix
            );
            const symbol = optimizer.getSymbol(score);

            document.getElementById('ind-score-display').textContent = score.toFixed(2);
            const symEl = document.getElementById('ind-symbol-display');
            symEl.textContent = symbol;
            symEl.style.color = getSymbolColor(symbol);

            // Set default choice to predicted
            const sel = document.getElementById('ind-actual-symbol');
            sel.value = symbol;
            sel.style.color = getSymbolColor(symbol);
            sel.onchange = (e) => e.target.style.color = getSymbolColor(e.target.value);

            document.getElementById('ind-result-card').style.display = 'block';
            document.getElementById('ind-result-card').scrollIntoView({ behavior: 'smooth' });
        }

        function commitIndividual() {
            const actualSymbol = document.getElementById('ind-actual-symbol').value;
            solverData.addObservation({
                childId: currentIndContext.child,
                f: currentIndContext.f, ff: currentIndContext.ff, fm: currentIndContext.fm,
                m: currentIndContext.m, mf: currentIndContext.mf, mm: currentIndContext.mm,
                s3: currentIndContext.s3, s2: currentIndContext.s2, noble: Number(document.getElementById('input-ind-noble').value),
                correctSymbol: actualSymbol
            });
            updateCountDisplay();

            // Show flash message or alert
            alert(`ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸ (ç¾åœ¨ã®ç™»éŒ²æ•°: ${solverData.getObservations().length})`);
            document.getElementById('ind-result-card').style.display = 'none';
        }

        // --- Modal Logic ---
        function openModal(inputId) {
            currentModalTarget = inputId;
            const modal = document.getElementById('monster-modal-ui');
            const list = document.getElementById('modal-list');
            list.innerHTML = '';

            MONSTER_NAMES.forEach((name, idx) => {
                const div = document.createElement('div');
                div.className = 'modal-item';
                div.innerHTML = `<img src="images/${name}.png" loading="lazy" onerror="this.src=''"><span>${name}</span>`;
                div.onclick = () => selectMonster(idx, name);
                list.appendChild(div);
            });
            // Use classList for flex display (centered)
            modal.classList.add('show');
        }

        function closeModalUI() {
            document.getElementById('monster-modal-ui').classList.remove('show');
        }

        // --- Manual Modal Logic ---
        function openManual() {
            document.getElementById('manual-modal').classList.add('show');
        }

        function closeManual() {
            document.getElementById('manual-modal').classList.remove('show');
        }

        function selectMonster(idx, name) {
            if (currentModalTarget) {
                document.getElementById(currentModalTarget).value = idx;
                const btn = document.getElementById('btn-' + currentModalTarget);
                btn.innerHTML = `<img src="images/${name}.png"><span>${name}</span>`;
                btn.classList.add('selected');
            }
            closeModalUI();
            saveAppState();
        }

        // --- Table Generation & Sorting ---
        function generateTable() {
            const getVal = (id) => document.getElementById(id).value === "" ? null : Number(document.getElementById(id).value);

            const inputs = {
                f: getVal('input-f'), ff: getVal('input-ff'), fm: getVal('input-fm'),
                m: getVal('input-m'), mf: getVal('input-mf'), mm: getVal('input-mm'),
                s3: Number(document.getElementById('input-s3').value),
                s2: Number(document.getElementById('input-s2').value),
                noble: Number(document.getElementById('input-noble').value)
            };

            if (inputs.f === null || inputs.ff === null || inputs.fm === null ||
                inputs.m === null || inputs.mf === null || inputs.mm === null) {
                alert("ã™ã¹ã¦ã®è¦ªãƒ»ç¥–çˆ¶æ¯ã‚’é¸æŠã—ã¦ãã ã•ã„");
                return;
            }

            currentContext = inputs;
            const tbody = document.querySelector('#children-table tbody');
            tbody.innerHTML = '';

            let results = [];
            MONSTER_NAMES.forEach((name, idx) => {
                const score = optimizer.calculateScore(idx, inputs.f, inputs.ff, inputs.fm, inputs.m, inputs.mf, inputs.mm,
                    inputs.s3, inputs.s2, inputs.noble, optimizer.matrix);
                const symbol = optimizer.getSymbol(score);
                results.push({ id: idx, name, score, symbol });
            });

            // Sort Descending
            results.sort((a, b) => b.score - a.score);

            results.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${d.name}</td>
                    <td style="font-weight:bold; color:${getSymbolColor(d.symbol)}">${d.symbol}</td>
                    <td>${d.score.toFixed(0)}</td>
                    <td>
                        <select class="symbol-select" data-child="${d.id}" data-predicted="${d.symbol}" style="color:${getSymbolColor(d.symbol)}">
                            <option value="ğŸ‘‘"${d.symbol === 'ğŸ‘‘' ? ' selected' : ''}>ğŸ‘‘</option>
                            <option value="â˜†"${d.symbol === 'â˜†' ? ' selected' : ''}>â˜†</option>
                            <option value="â—"${d.symbol === 'â—' ? ' selected' : ''}>â—</option>
                            <option value="â—‹"${d.symbol === 'â—‹' ? ' selected' : ''}>â—‹</option>
                            <option value="â–³"${d.symbol === 'â–³' ? ' selected' : ''}>â–³</option>
                            <option value="Ã—"${d.symbol === 'Ã—' ? ' selected' : ''}>Ã—</option>
                        </select>
                    </td>
                `;
                const sel = tr.querySelector('select');
                sel.addEventListener('change', (e) => {
                    const newSym = e.target.value;
                    sel.style.color = getSymbolColor(newSym);
                    if (newSym !== d.symbol) tr.style.backgroundColor = '#3a2a00';
                    else tr.style.backgroundColor = '';
                });
                tbody.appendChild(tr);
            });

            document.getElementById('step2-card').style.display = 'block';
            setTimeout(() => {
                document.getElementById('step2-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function getSymbolColor(s) {
            if (s === 'ğŸ‘‘') return '#ffd700';
            if (s === 'â˜†') return '#ffa500';
            if (s === 'â—') return '#ff5555';
            if (s === 'â—‹') return '#55ff55';
            return '#fff';
        }

        // --- Commit & Clear ---
        function commitObservations() {
            // Scope to children-table to avoid picking up Individual Mode selectors
            const selects = document.querySelectorAll('#children-table .symbol-select');
            let count = 0;
            selects.forEach(sel => {
                // Task: Only add to list if symbol is different from predicted
                if (sel.value !== sel.dataset.predicted) {
                    solverData.addObservation({
                        childId: Number(sel.dataset.child),
                        ...currentContext,
                        correctSymbol: sel.value
                    });
                    count++;
                }
            });
            updateCountDisplay();
            document.getElementById('step2-card').style.display = 'none';
            log(`Added ${count} records. Total: ${solverData.getObservations().length}`);
        }

        function execClear() {
            solverData.clear();
            updateCountDisplay();
            log("All data cleared.");
            alert("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ");
        }

        // --- Optimization ---
        async function runOptimization() {
            const obs = solverData.getObservations();
            if (obs.length === 0) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");

            const btn = document.getElementById('btn-optimize');
            btn.disabled = true;
            btn.innerText = "æœ€é©åŒ–ä¸­...";

            const progress = document.getElementById('progress-bar');
            document.getElementById('progress-container').style.display = 'block';
            log("Optimization Started...");

            const result = await optimizer.optimize(obs, 5000, 0.5, (i, tot, ev) => {
                const pct = (i / tot) * 100;
                progress.style.width = pct + "%";
                if (i % 200 === 0) {
                    log(`Iter ${i}: Penalty ${ev.penalty.toFixed(0)} / Conflicts ${ev.contradictions}`);
                }
            });

            log(`COMPLETE! Final Penalty: ${result.eval.penalty.toFixed(1)}`);
            progress.style.width = "100%";
            btn.disabled = false;
            btn.innerText = "æœ€é©åŒ–ã‚’ã‚¹ã‚¿ãƒ¼ãƒˆ";

            renderMatrix(result.matrix, optimizer.originalMatrix);
            saveAppState(); // Save optimized matrix
        }

        function log(msg) {
            const p = document.getElementById('log-panel');
            const time = new Date().toLocaleTimeString();
            p.innerHTML += `<div><span style="color:#555;">[${time}]</span> ${msg}</div>`;
            p.scrollTop = p.scrollHeight;
        }

        // --- Matrix Display with Diff ---
        function renderMatrix(current, original) {
            const table = document.getElementById('matrix-display');
            table.innerHTML = '';

            let thead = '<tr><th></th>';
            MONSTER_NAMES.forEach(n => {
                thead += `<th><img src="images/${n}.png" title="${n}"></th>`;
            });
            thead += '</tr>';
            table.innerHTML += thead;

            for (let r = 0; r < current.length; r++) {
                const row = document.createElement('tr');
                let html = `<th><img src="images/${MONSTER_NAMES[r]}.png" title="${MONSTER_NAMES[r]}"></th>`;

                for (let c = 0; c < current[r].length; c++) {
                    const val = current[r][c];

                    // Diff Logic
                    // Ensure original exists and has matching dimensions, otherwise fallback to val
                    const origVal = (original && original[r] && typeof original[r][c] === 'number') ? original[r][c] : val;
                    const diff = val - origVal;
                    let diffHtml = '<span class="diff-zero"></span>';
                    let cellClass = '';

                    if (Math.abs(diff) >= 0.1) {
                        cellClass = 'cell-changed';
                        if (diff > 0) diffHtml = `<span class="diff-pos">(+${diff.toFixed(1)})</span>`;
                        else diffHtml = `<span class="diff-neg">(${diff.toFixed(1)})</span>`;
                    }

                    html += `<td class="${cellClass}">${val.toFixed(1)}${diffHtml}</td>`;
                }
                row.innerHTML = html;
                table.appendChild(row);
            }
        }

        // --- Persistence (Backup/Restore) ---
        function backupData() {
            const obs = solverData.getObservations();
            if (obs.length === 0) {
                alert("ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
                return;
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(obs));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "solver_backup.json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        solverData.observations = data; // Direct assignment or clear+add
                        solverData.save();
                        updateCountDisplay();
                        alert(`å¾©å…ƒã—ã¾ã—ãŸ (${data.length}ä»¶)\nâ€»çŠ¶æ…‹ã‚„ãƒãƒˆãƒªã‚¯ã‚¹ã¯åˆ¥é€”ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
                    } else {
                        alert("ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™");
                    }
                } catch (err) {
                    alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err);
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset
        }

        function exportAsPatch() {
            // Compare current matrix with original default Matrix (from data.js COMPATIBILITY_MATRIX)
            // But wait, optimizer.originalMatrix is initialized with COMPATIBILITY_MATRIX.
            // If optimization ran, optimizer.matrix is updated.

            if (!optimizer) return;

            // Check if any change actually happened
            let hasChange = false;
            for (let r = 0; r < optimizer.matrix.length; r++) {
                for (let c = 0; c < optimizer.matrix[r].length; c++) {
                    if (Math.abs(optimizer.matrix[r][c] - optimizer.originalMatrix[r][c]) > 0.1) {
                        hasChange = true;
                        break;
                    }
                }
            }

            if (!hasChange) {
                alert("å¤‰æ›´ç‚¹ãŒãªã„ãŸã‚ã€ãƒ‘ãƒƒãƒã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã€‚");
                return;
            }

            const patch = {};
            MONSTER_NAMES.forEach((name, r) => {
                const rowObj = {};
                let rowHasChange = false;
                MONSTER_NAMES.forEach((target, c) => {
                    const val = optimizer.matrix[r][c];
                    // Save only if different from default? Or save all? 
                    // Usually patches are sparse, but here a fill matrix is arguably safer/easier.
                    // Let's save the full row if we want a complete override, OR just diffs.
                    // For simplicity, let's export the FULL matrix to ensure it works.
                    rowObj[target] = Number(val.toFixed(1));
                });
                patch[name] = rowObj;
            });

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(patch, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "mf_sim_patch.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }


        // --- Noble Modal Functions ---
        function openNobleModal() {
            document.getElementById('noble-modal').classList.add('show');
        }
        function closeNobleModal() {
            document.getElementById('noble-modal').classList.remove('show');
        }

        // --- Save Matrix Image ---
        async function saveMatrixImage() {
            // Draw matrix to canvas and download
            const matrix = optimizer.matrix;
            const size = matrix.length;
            const cellSize = 50;
            const headerSize = 50;
            const width = headerSize + size * cellSize;
            const height = headerSize + size * cellSize;

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');

            // Background
            ctx.fillStyle = "#1e1e1e";
            ctx.fillRect(0, 0, width, height);

            ctx.font = "14px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.lineWidth = 1;

            // Wait for images
            const loadImg = (name) => new Promise(resolve => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => resolve(null);
                img.src = `images/${name}.png`;
            });

            const imgs = await Promise.all(MONSTER_NAMES.map(n => loadImg(n)));

            // Draw Top Header
            for (let i = 0; i < size; i++) {
                const x = headerSize + i * cellSize;
                ctx.strokeStyle = "#333";
                ctx.strokeRect(x, 0, cellSize, headerSize);
                if (imgs[i]) ctx.drawImage(imgs[i], x + 5, 5, 40, 40);
            }
            // Draw Left Header & Data
            for (let r = 0; r < size; r++) {
                const y = headerSize + r * cellSize;
                // Header
                ctx.strokeRect(0, y, headerSize, cellSize);
                if (imgs[r]) ctx.drawImage(imgs[r], 5, y + 5, 40, 40);

                for (let c = 0; c < size; c++) {
                    const x = headerSize + c * cellSize;
                    const val = matrix[r][c];

                    // Highlight logic
                    const orig = optimizer.originalMatrix[r][c];
                    const diff = val - orig;

                    if (Math.abs(diff) >= 0.1) {
                        ctx.fillStyle = "#3d2b00";
                        ctx.fillRect(x, y, cellSize, cellSize);
                    }

                    ctx.fillStyle = "#e0e0e0";
                    ctx.fillText(val.toFixed(1), x + cellSize / 2, y + cellSize / 2);

                    // Diff text
                    if (Math.abs(diff) >= 0.1) {
                        ctx.font = "10px Arial";
                        if (diff > 0) ctx.fillStyle = "#55ff55";
                        else ctx.fillStyle = "#ff5555";
                        const label = diff > 0 ? `+${diff.toFixed(1)}` : `(${diff.toFixed(1)})`;
                        ctx.fillText(label, x + cellSize / 2, y + cellSize - 8);

                        // Reset font
                        ctx.font = "14px Arial";
                    }

                    ctx.strokeStyle = "#333";
                    ctx.strokeRect(x, y, cellSize, cellSize);
                }
            }

            const link = document.createElement('a');
            link.download = 'affinity_matrix_optimized.png';
            link.href = canvas.toDataURL("image/png");
            link.click();
        }
    </script>
</body>

</html>